/**
 * 项目名称：SanXine.com善行网，“打造国内有车一族的第一社区”
 * 版权申明：sanxine.com所有，未经许可不得在任何软件中以任何形式使用全部或部分代码，不得更改本项目的代码。
 * 文件名称：TestBeanBeanQuery.java
 * 创建时间：2011-4-26-下午10:19:29
 * 创建用户：chis(chis123@qq.com)
 * 文件描述：
 * 修改记录：
 *   
 */
package test.rapidweb2.spring.beanmapper;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import junit.framework.Assert;

import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.AbstractApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

import com.rapidweb2.spring.SpringUtil;
import com.rapidweb2.spring.beanmapper.BeanQuery;
import com.rapidweb2.spring.beanmapper.BeanUpdate;

/**
 * 测试BeanMapper
 * 
 * @author chis(chis123@qq.com)
 */
public class TestBeanUpdate {
	private static ApplicationContext	context;
	static {
		context = new ClassPathXmlApplicationContext("classpath:/test/rapidweb2/spring/beanmapper/main.xml");
		((AbstractApplicationContext) context).registerShutdownHook(); // auto-destory single-bean. chis.
	}

	BeanUpdate<SysUser>					update;
	BeanQuery<SysUser>					query;

	/**
	 * @throws java.lang.Exception
	 */
	@BeforeClass
	public static void setUpBeforeClass() throws Exception {

	}

	/**
	 * @throws java.lang.Exception
	 */
	@Before
	public void setUp() throws Exception {
		query = SpringUtil.getBeanQuery(SysUser.class);
		update = SpringUtil.getBeanUpdate(SysUser.class);
	}

	/**
	 * 测试
	 */
	@Test
	public void insert() {
		SysUser user = query.clear().id(9).getOne();
		Assert.assertEquals(user.getLog_Id(), "xiaoxiu");
		
		user.setLog_Id("xiuxiu");
		update.clear().of(user).insert();
		user = query.clear().where("log_id=?", "xiuxiu").getOne();
		Assert.assertNotNull(user);
		
		user.setLog_Id("xiu01");
		user.setUname("张三");
		update.clear().of(user).properties("log_Id,uname").insert();
		user = query.clear().where("log_id=?", "xiu01").getOne();
		Assert.assertNotNull(user);
		
		// 测试数组
		List<SysUser> users = new ArrayList<SysUser>();
		for( int i=0;i<10;i++ ){
			SysUser u = new SysUser();
			u.setLog_Id("xiu-" + i);
			u.setUname("张" + i );
			users.add(u);
		}
		update.clear().of(users).properties("log_Id,uname").insert();
		
//		int cnt = query.clear().where("log_id like 'xiu-%'").getCount();
//		Assert.assertEquals(cnt, 10);
	}

	@Test 
	public void InsertBean(){
		SysUser user = query.clear().id(9).getOne();
		Assert.assertEquals(user.getLog_Id(), "xiaoxiu");
		
		// 单个增加
		user.setLog_Id("xiuxiu123");
		SysUser u = update.clear().of(user).insertBean();
		Assert.assertEquals(u.getLog_Id(), "xiuxiu123");
		// 增加多个
		List<SysUser> list = new ArrayList<SysUser>();
		for( int i=0;i<10;i++ ) {
			SysUser newuser = new SysUser();
			newuser.setLog_Id("xiu="+i);
			newuser.setIp_Last("好吧");
			newuser.setEmail((new Date()).toLocaleString());
			list.add(newuser);
		}
		update.clear().of(list).exclude("ip_last,email").insertBeans();
	}
	
	@Test
	public void update() {
		SysUser user = query.clear().id(9).getOne();
		Assert.assertEquals(user.getLog_Id(), "xiaoxiu");
		
//		user.setEmail((new Date()).toLocaleString());
//		update.clear().of(user).update();
//		
//		// 
//		user.setPasswd((new Date()).toLocaleString());
//		user.setLoc_Last("IP：" + (new Date()).toLocaleString());
//		update.clear().of(user).properties("passwd,loc_last").update();
		
		user.setPasswd((new Date()).toLocaleString());
		user.setLoc_Last("IP：" + (new Date()).toLocaleString());
		// where
		update.clear().of(user).properties("passwd,loc_last").where("uname=?", "张2").update();
	}
	
	@Test
	public void delete(){
		// 按照WHERE 删除
		update.clear().where("uname=?", "张2").delete();
		// 按照ID删除
		update.clear().id(12).delete();
		// 按照IDS删除
		update.clear().ids(new Object[]{13,14,15}).delete();
		// 按照BEAN来删除
		SysUser user = query.clear().id(27).getOne();
		update.clear().of(user).delete();
		
	}

}
